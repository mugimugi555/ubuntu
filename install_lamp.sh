#!/bin/bash

#-----------------------------------------------------------------------------------------------------------------------
# LAMP ç’°å¢ƒã®æœ€æ–° PHP ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
#-----------------------------------------------------------------------------------------------------------------------

echo "âœ… Ubuntu LAMP ã‚¹ã‚¿ãƒƒã‚¯ & æœ€æ–° PHP ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹..."

#-----------------------------------------------------------------------------------------------------------------------
# å¿…è¦ãªãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ 
#-----------------------------------------------------------------------------------------------------------------------
sudo apt update && sudo apt upgrade -y
sudo apt install -y ca-certificates apt-transport-https software-properties-common wget curl lsb-release

# PHP ã®å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªè¿½åŠ ï¼ˆæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—å¯èƒ½ã«ã™ã‚‹ï¼‰
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update

#-----------------------------------------------------------------------------------------------------------------------
# æœ€æ–°ã® PHP ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
#-----------------------------------------------------------------------------------------------------------------------
LATEST_PHP_VERSION=$(apt-cache search php | grep -oP '^php[0-9]+\.[0-9]+' | sort -V | tail -n 1 | sed 's/php//')
echo "âœ… æœ€æ–°ã® PHP ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $LATEST_PHP_VERSION"

#-----------------------------------------------------------------------------------------------------------------------
# Apache, æœ€æ–° PHP, MySQL ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
#-----------------------------------------------------------------------------------------------------------------------
sudo apt install -y \
  apache2 \
  php$LATEST_PHP_VERSION php$LATEST_PHP_VERSION-fpm \
  php$LATEST_PHP_VERSION-mbstring php$LATEST_PHP_VERSION-mysql php$LATEST_PHP_VERSION-curl \
  php$LATEST_PHP_VERSION-gd php$LATEST_PHP_VERSION-zip php$LATEST_PHP_VERSION-xml \
  mariadb-server

#-----------------------------------------------------------------------------------------------------------------------
# Apache ã§ PHP-FPM ã‚’æœ‰åŠ¹åŒ–
#-----------------------------------------------------------------------------------------------------------------------
sudo apt install -y libapache2-mod-fcgid
sudo a2enmod proxy_fcgi setenvif
sudo a2enconf php$LATEST_PHP_VERSION-fpm
sudo systemctl restart apache2

#-----------------------------------------------------------------------------------------------------------------------
# ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã®ä½œæˆ
#-----------------------------------------------------------------------------------------------------------------------
sudo rm -f /var/www/html/index.html
echo "<?php phpinfo();" | sudo tee /var/www/html/index.php > /dev/null

LOCAL_IPADDRESS=$(hostname -I | awk '{print $1}')
echo "======================================"
echo "ğŸš€ PHP $LATEST_PHP_VERSION ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸï¼"
echo "ğŸŒ ã‚µã‚¤ãƒˆã‚’é–‹ã => http://$LOCAL_IPADDRESS/"
echo "======================================"

# è‡ªå‹•ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ãï¼ˆGUI ç’°å¢ƒã®å ´åˆï¼‰
if command -v xdg-open &> /dev/null; then
    xdg-open http://$LOCAL_IPADDRESS/ &
fi
